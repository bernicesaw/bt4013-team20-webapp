%% Mermaid diagram for signup/login/profile flows
flowchart TD
  A[Browser] -->|POST /accounts/signup| B(Django signup_view)
  B --> C[Validate SignupForm & Password]
  C -->|valid| D[Create Django User, Profile, WorkExperience]
  D --> E[Upsert to Supabase users table (REST upsert on email)]
  E -->|200/OK| F[Supabase stores mirrored profile]
  E -->|error| G[Log error; continue (local DB is source-of-truth for auth)]
  D --> H[Redirect -> signup_success]

  A2[Browser] -->|POST /accounts/login| L(Django auth)
  L -->|check local auth_user| M[Local DB: auth_user]
  M -->|valid| N[Create session cookie]
  M -->|invalid| O[Login failed]

  %% Profile update
  P1[Browser] -->|POST /accounts/profile| P2(Django profile_view)
  P2 --> P3[Validate profile input]
  P3 --> P4[Update local Profile & WorkExperience]
  P4 --> P5[Upsert to Supabase users table]
  P5 -->|200| P6[Supabase updated]
  P5 -->|error| P7[Log error; local DB updated]

  %% Settings changes: notifications
  S1[Browser] -->|POST /accounts/settings (notifications)| S2(Django settings_view)
  S2 --> S3[Update profile.notifications_enabled]
  S3 --> S4[Upsert to Supabase {email, notifications_enabled}]

  %% Settings changes: password
  PW1[Browser] -->|POST /accounts/settings (change_password)| PW2(Django PasswordChangeForm)
  PW2 --> PW3[validate_password_strength(new_password)]
  PW3 -->|valid| PW4[Update auth_user password hash]
  PW4 --> PW5[update_session_auth_hash]

  style B fill:#f9f,stroke:#333,stroke-width:1px
  style L fill:#bbf,stroke:#333,stroke-width:1px
  style P2 fill:#efe,stroke:#333,stroke-width:1px
  style S2 fill:#ffd,stroke:#333,stroke-width:1px
  style PW2 fill:#fdd,stroke:#333,stroke-width:1px
